import{A as x,B as a,Db as R,E as k,O as A,ab as S,d as E,g as p,h as c,i as j,j as b,k as v,q as u,qb as T,rb as D,sb as H,u as m,w as d,z as f}from"./chunk-DTN2F3G6.js";import{a as M}from"./chunk-JCVLWF7J.js";var w=class extends Error{constructor(){super(...arguments),this.isAppError=!0}};var I=class extends w{constructor(){super("Unauthorized")}};var J={"cannot update published preset":"cannot update shared preset."},K=o=>J[o?.error?.message]||o?.error?.message||o?.statusText||o?.error;var $=new A("JWT_OPTIONS"),g=(()=>{class o{constructor(t=null){this.tokenGetter=t&&t.tokenGetter||function(){}}urlBase64Decode(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:{e+="==";break}case 3:{e+="=";break}default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(e)}b64decode(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i=0,l,n,_=0;n=t.charAt(_++);~n&&(l=i%4?l*64+n:n,i++%4)?r+=String.fromCharCode(255&l>>(-2*i&6)):0)n=e.indexOf(n);return r}b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this.b64decode(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}decodeToken(t=this.tokenGetter()){return t instanceof Promise?t.then(e=>this._decodeToken(e)):this._decodeToken(t)}_decodeToken(t){if(!t||t==="")return null;let e=t.split(".");if(e.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let r=this.urlBase64Decode(e[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)}getTokenExpirationDate(t=this.tokenGetter()){return t instanceof Promise?t.then(e=>this._getTokenExpirationDate(e)):this._getTokenExpirationDate(t)}_getTokenExpirationDate(t){let e;if(e=this.decodeToken(t),!e||!e.hasOwnProperty("exp"))return null;let r=new Date(0);return r.setUTCSeconds(e.exp),r}isTokenExpired(t=this.tokenGetter(),e){return t instanceof Promise?t.then(r=>this._isTokenExpired(r,e)):this._isTokenExpired(t,e)}_isTokenExpired(t,e){if(!t||t==="")return!0;let r=this.getTokenExpirationDate(t);return e=e||0,r===null?!1:!(r.valueOf()>new Date().valueOf()+e*1e3)}getAuthScheme(t,e){return typeof t=="function"?t(e):t}}return o.\u0275fac=function(t){return new(t||o)(a($))},o.\u0275prov=f({token:o,factory:o.\u0275fac}),o})(),U=o=>o instanceof Promise?v(()=>o):p(o),G=(()=>{class o{constructor(t,e,r){this.jwtHelper=e,this.document=r,this.standardPorts=["80","443"],this.tokenGetter=t.tokenGetter,this.headerName=t.headerName||"Authorization",this.authScheme=t.authScheme||t.authScheme===""?t.authScheme:"Bearer ",this.allowedDomains=t.allowedDomains||[],this.disallowedRoutes=t.disallowedRoutes||[],this.throwNoTokenError=t.throwNoTokenError||!1,this.skipWhenExpired=t.skipWhenExpired}isAllowedDomain(t){let e=new URL(t.url,this.document.location.origin);if(e.host===this.document.location.host)return!0;let r=`${e.hostname}${e.port&&!this.standardPorts.includes(e.port)?":"+e.port:""}`;return this.allowedDomains.findIndex(i=>typeof i=="string"?i===r:i instanceof RegExp?i.test(r):!1)>-1}isDisallowedRoute(t){let e=new URL(t.url,this.document.location.origin);return this.disallowedRoutes.findIndex(r=>{if(typeof r=="string"){let i=new URL(r,this.document.location.origin);return i.hostname===e.hostname&&i.pathname===e.pathname}return r instanceof RegExp?r.test(t.url):!1})>-1}handleInterception(t,e,r){let i=this.jwtHelper.getAuthScheme(this.authScheme,e);if(!t&&this.throwNoTokenError)throw new Error("Could not get token from tokenGetter function.");let l=p(!1);return this.skipWhenExpired&&(l=t?U(this.jwtHelper.isTokenExpired(t)):p(!0)),t?l.pipe(j(n=>n&&this.skipWhenExpired?e.clone():e.clone({setHeaders:{[this.headerName]:`${i}${t}`}})),b(n=>r.handle(n))):r.handle(e)}intercept(t,e){if(!this.isAllowedDomain(t)||this.isDisallowedRoute(t))return e.handle(t);let r=this.tokenGetter(t);return U(r).pipe(b(i=>this.handleInterception(i,t,e)))}}return o.\u0275fac=function(t){return new(t||o)(a($),a(g),a(S))},o.\u0275prov=f({token:o,factory:o.\u0275fac}),o})(),he=(()=>{class o{constructor(t){if(t)throw new Error("JwtModule is already loaded. It should only be imported in your application's main module.")}static forRoot(t){return{ngModule:o,providers:[{provide:D,useClass:G,multi:!0},t.jwtOptionsProvider||{provide:$,useValue:t.config},g]}}}return o.\u0275fac=function(t){return new(t||o)(a(o,12))},o.\u0275mod=k({type:o}),o.\u0275inj=x({}),o})();var h=R.roBackendUrl,z="refreshToken",P=class{constructor(){this.API={base:h,login:`${h}/login`,logout:`${h}/me/logout`,refreshToken:`${h}/refresh_token`,getMyProfile:`${h}/me`,getMyEntirePreset:`${h}/me/ro_entire_presets`,getMyPreset:`${h}/me/ro_presets`,getMyPresets:`${h}/me/ro_presets`,createMyPreset:`${h}/me/ro_presets`,bulkCreateMyPresets:`${h}/me/bulk_ro_presets`,likePresetTags:`${h}/preset_tags`,sharedPresets:`${h}/ro_presets`}}getRefreshToken(){return localStorage.getItem(z)}isUnauthorizedErr(s){return s?.message==="Unauthorized"||s?.status===401}handleUnauthErr(){return localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),c(()=>new I)}storeToken(s){localStorage.setItem("accessToken",s.accessToken),localStorage.setItem("refreshToken",s.refreshToken)}refreshToken(){let s=this.getRefreshToken();return s?this.http.post(`${this.API.refreshToken}`,{refreshToken:s}).pipe(d(t=>this.storeToken(t))):this.handleUnauthErr()}getAuthHeaders(){return{headers:{authorization:`bearer ${this.jwtHelper.tokenGetter()}`}}}get(s,t=!0){let e;return t?e=(this.jwtHelper.isTokenExpired()?this.refreshToken():p(null)).pipe(m(()=>this.http.get(s,this.getAuthHeaders()))):e=this.http.get(s),e.pipe(u(r=>this.isUnauthorizedErr(r)?this.handleUnauthErr():(console.error({err:r}),c(()=>r))))}post(s,t,e=!0){let r;return e?r=(this.jwtHelper.isTokenExpired()?this.refreshToken():p(null)).pipe(m(()=>this.http.post(s,t,this.getAuthHeaders()))):r=this.http.post(s,t),r.pipe(u(i=>this.isUnauthorizedErr(i)?this.handleUnauthErr():(console.error({err:i}),c(()=>i))))}delete(s,t=!0){let e;return t?e=(this.jwtHelper.isTokenExpired()?this.refreshToken():p(null)).pipe(m(()=>this.http.delete(s,this.getAuthHeaders()))):e=this.http.delete(s),e.pipe(u(r=>this.isUnauthorizedErr(r)?this.handleUnauthErr():(console.error({err:r}),c(()=>r))))}};var O=(()=>{let s=class s extends P{constructor(e,r){super(),this.http=e,this.jwtHelper=r,this.profileEvent=new E(1),this.profileEventObs$=this.profileEvent.asObservable(),this.loggedInSubject=new E(1),this.loggedInEvent$=this.loggedInSubject.asObservable(),this.isLoggedIn=!1,this.getMyProfile().subscribe(),this.loggedInEvent$.subscribe(i=>this.isLoggedIn=i)}login(e){return this.profile=void 0,this.post(`${this.API.login}`,{authorizationCode:e},!1).pipe(d(r=>this.storeToken(r)),m(()=>this.getMyProfile()))}logout(){return this.post(`${this.API.logout}`,{}).subscribe({next:()=>{console.log("logout")},error:e=>{console.error({err:e})},complete:()=>{localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),this.storeProfile({}),this.loggedInSubject.next(!1)}})}getMyProfile(){return this.get(this.API.getMyProfile).pipe(d(r=>this.storeProfile(r)),d(r=>{r?.id&&this.loggedInSubject.next(!0)}),u(()=>(this.loggedInSubject.next(!1),p(null))))}updateMyProfile(e){return this.post(this.API.getMyProfile,e).pipe(d(r=>this.storeProfile(r)),u(r=>(this.loggedInSubject.next(!1),c(()=>r))))}storeProfile(e){this.profile=M({},e),this.profileEvent.next(this.profile)}getProfile(){return this.profile}};s.\u0275fac=function(r){return new(r||s)(a(T),a(g))},s.\u0275prov=f({token:s,factory:s.\u0275fac});let o=s;return o})();var C=(()=>{let s=class s extends P{constructor(e,r){super(),this.http=e,this.jwtHelper=r}getPreset(e){return this.get(`${this.API.getMyPreset}/${e}`)}getMyPresets(){return this.get(`${this.API.getMyPreset}`)}getEntirePresets(){return this.get(`${this.API.getMyEntirePreset}`)}createPreset(e){return this.post(`${this.API.createMyPreset}`,e)}bulkCreatePresets(e){return this.post(`${this.API.bulkCreateMyPresets}`,e)}updatePreset(e,r){return this.post(`${this.API.getMyPreset}/${e}`,r)}deletePreset(e){return this.delete(`${this.API.getMyPreset}/${e}`)}sharePreset(e,r){return this.post(`${this.API.getMyPreset}/${e}/publish`,r)}unsharePreset(e){return this.delete(`${this.API.getMyPreset}/${e}/publish`)}addPresetTags(e,r){return this.post(`${this.API.getMyPreset}/${e}/tags`,r)}removePresetTag(e){let{presetId:r,tagId:i}=e;return this.delete(`${this.API.getMyPreset}/${r}/tags/${i}`)}likePresetTags(e){return this.post(`${this.API.likePresetTags}/${e}/like`,{})}unlikePresetTag(e){return this.delete(`${this.API.likePresetTags}/${e}/like`)}getPublishPresets(e){let{classId:r,tagName:i,skip:l,take:n}=e;return this.get(`${this.API.sharedPresets}/class_by_tags/${r}/${i}?skip=${l||0}&take=${n||1}`)}};s.\u0275fac=function(r){return new(r||s)(a(T),a(g))},s.\u0275prov=f({token:s,factory:s.\u0275fac});let o=s;return o})();var Ie=(()=>{let s=class s{};s.\u0275fac=function(r){return new(r||s)},s.\u0275mod=k({type:s}),s.\u0275inj=x({providers:[O,C],imports:[H]});let o=s;return o})();export{I as a,K as b,he as c,O as d,C as e,Ie as f};
